<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Network Graph - @guinetik/network-js</title>
    <link rel="stylesheet" href="../styles/main.css">
    <script>
        // Detect dark mode from localStorage (same as main app)
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
        }
    </script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: transparent;
        }

        #graph-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.5) 0%, rgba(249, 250, 251, 0.5) 100%);
            position: relative;
        }

        .dark #graph-container {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.7) 0%, rgba(22, 33, 62, 0.7) 100%);
        }

        #graph-container svg {
            background: transparent;
        }
    </style>
</head>
<body class="dark:bg-transparent">
    <!-- Back Button -->
    <a
        href="../index.html"
        class="fixed top-4 right-4 z-50 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow-lg transition-colors"
    >
        ‚Üê Back to Home
    </a>

    <!-- Split Layout -->
    <div class="flex flex-col lg:flex-row h-screen" x-data="networkGraphApp()">
        <!-- Left Panel: Info & Controls -->
        <div class="lg:w-1/3 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-r border-gray-200/50 dark:border-gray-700/50 overflow-y-auto p-6 space-y-6">
            <!-- Header -->
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2">
                    üï∏Ô∏è Interactive Network Graph
                </h1>
                <p class="text-gray-600 dark:text-gray-400">
                    Explore network analysis in real-time. Add nodes, remove them, and watch the centrality metrics update dynamically.
                </p>
            </div>

            <!-- What is this? -->
            <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-blue-900 dark:text-blue-300 mb-2">What is this?</h2>
                <p class="text-sm text-blue-800 dark:text-blue-200">
                    This interactive visualization demonstrates <strong>eigenvector centrality</strong> -
                    a measure of influence in a network. Node size represents importance: larger nodes
                    are more influential because they're connected to other influential nodes.
                </p>
            </div>

            <!-- Controls -->
            <div class="space-y-3">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Controls</h2>

                <button
                    @click="addRandomNode()"
                    class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-semibold transition-colors shadow-sm"
                >
                    ‚ûï Add Random Node
                </button>

                <button
                    @click="addSpecificNode()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-semibold transition-colors shadow-sm"
                >
                    üîó Add Node to "Alice"
                </button>

                <button
                    @click="removeRandomNode()"
                    class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg font-semibold transition-colors shadow-sm"
                >
                    ‚ûñ Remove Random Node
                </button>
            </div>

            <!-- Data Loading -->
            <div class="space-y-3 border-t border-gray-200 dark:border-gray-700 pt-4">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Load Data</h2>

                <div class="space-y-2">
                    <label for="data-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Choose Dataset:
                    </label>
                    <select
                        x-model="selectedDataset"
                        class="w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                        <option value="default">Default (Simple)</option>
                        <option value="karate-json">Karate Club - JSON (34 nodes)</option>
                        <option value="karate-csv">Karate Club - CSV (34 nodes)</option>
                        <option value="miserables">Les Mis√©rables - CSV (77 nodes)</option>
                    </select>
                </div>

                <button
                    @click="loadData()"
                    :disabled="isLoading"
                    class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white px-4 py-3 rounded-lg font-semibold transition-colors shadow-sm"
                >
                    <span x-show="!isLoading">üìä Load Dataset</span>
                    <span x-show="isLoading">‚è≥ Loading...</span>
                </button>
            </div>

            <!-- Layout Controls -->
            <div class="space-y-3 border-t border-gray-200 dark:border-gray-700 pt-4">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Layout Algorithm</h2>

                <div class="space-y-2">
                    <label for="layout-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Choose Layout:
                    </label>
                    <select
                        x-model="selectedLayout"
                        class="w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 px-3 py-2 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    >
                        <option value="none">None (D3 Physics)</option>
                        <option value="force-directed">Force-Directed</option>
                        <option value="circular">Circular</option>
                    </select>
                </div>

                <button
                    @click="applyLayoutAlgorithm()"
                    class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg font-semibold transition-colors shadow-sm"
                >
                    üéØ Apply Layout
                </button>

                <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-lg p-3">
                    <p class="text-xs text-yellow-800 dark:text-yellow-200">
                        <strong>None:</strong> D3's built-in physics simulation<br>
                        <strong>Force-Directed:</strong> Custom spring-electrical model<br>
                        <strong>Circular:</strong> Distance-based positioning
                    </p>
                </div>
            </div>

            <!-- Node Info (Alpine-powered reactive display) -->
            <div id="node-info-container" class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-4">
                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Node Information</h3>
                <div class="text-sm">
                    <!-- Default state -->
                    <template x-if="nodeInfo.type === 'default'">
                        <div class="text-gray-600 dark:text-gray-400" x-text="nodeInfo.message"></div>
                    </template>

                    <!-- Loading state -->
                    <template x-if="nodeInfo.type === 'loading'">
                        <div class="space-y-1">
                            <div class="text-blue-600 dark:text-blue-400"><strong>‚è≥ Loading...</strong></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400" x-text="nodeInfo.message"></div>
                        </div>
                    </template>

                    <!-- Success state (dataset loaded) -->
                    <template x-if="nodeInfo.type === 'success'">
                        <div class="space-y-1">
                            <div class="text-green-600 dark:text-green-400"><strong>‚úì</strong> <span x-text="nodeInfo.message"></span></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                <span x-text="nodeInfo.details?.nodes"></span> nodes, <span x-text="nodeInfo.details?.edges"></span> edges
                            </div>
                            <div x-show="nodeInfo.details?.communities" class="text-xs text-purple-600 dark:text-purple-400 mt-2">
                                üé® Detected <span x-text="nodeInfo.details?.communities"></span> communities
                            </div>
                            <div x-show="nodeInfo.details?.description" class="text-xs text-gray-500 dark:text-gray-400 mt-2" x-text="nodeInfo.details?.description"></div>
                        </div>
                    </template>

                    <!-- Error state -->
                    <template x-if="nodeInfo.type === 'error'">
                        <div class="text-red-600 dark:text-red-400">
                            <strong>‚ùå</strong> <span x-text="nodeInfo.message"></span>
                        </div>
                    </template>

                    <!-- Node added -->
                    <template x-if="nodeInfo.type === 'node-added'">
                        <div>
                            <p class="text-green-600 dark:text-green-400 font-semibold">‚úÖ <span x-text="nodeInfo.message"></span></p>
                            <p class="mt-2"><strong>ID:</strong> <span x-text="nodeInfo.details?.nodeId"></span></p>
                            <p><strong>Connected to:</strong> <span x-text="nodeInfo.details?.connectedTo"></span></p>
                            <p class="text-xs mt-2 text-gray-500">The graph will re-layout automatically</p>
                        </div>
                    </template>

                    <!-- Node removed -->
                    <template x-if="nodeInfo.type === 'node-removed'">
                        <div>
                            <p class="text-orange-600 dark:text-orange-400 font-semibold">üóëÔ∏è <span x-text="nodeInfo.message"></span></p>
                            <p class="mt-2"><strong>ID:</strong> <span x-text="nodeInfo.details?.nodeId"></span></p>
                            <p class="text-xs mt-2 text-gray-500">Connected edges were also removed</p>
                        </div>
                    </template>

                    <!-- Layout applied -->
                    <template x-if="nodeInfo.type === 'layout-applied'">
                        <div class="space-y-1">
                            <div class="text-green-600 dark:text-green-400"><strong>‚úì</strong> <span x-text="nodeInfo.message"></span></div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-2" x-text="nodeInfo.details?.description"></div>
                        </div>
                    </template>

                    <!-- Node hover (live node info) -->
                    <template x-if="nodeInfo.type === 'node-hover'">
                        <div class="space-y-1">
                            <div class="text-blue-600 dark:text-blue-400 font-semibold">
                                üîµ <span x-text="nodeInfo.details?.id"></span>
                            </div>
                            <div class="text-sm text-gray-700 dark:text-gray-300 space-y-0.5">
                                <p><strong>Group:</strong> <span x-text="nodeInfo.details?.group"></span></p>
                                <p><strong>Centrality:</strong> <span x-text="nodeInfo.details?.centrality"></span></p>
                                <p><strong>Degree:</strong> <span x-text="nodeInfo.details?.degree"></span></p>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-purple-50 dark:bg-purple-900/30 rounded-lg p-4">
                <h3 class="text-sm font-semibold text-purple-900 dark:text-purple-300 mb-2">üí° How to interact</h3>
                <ul class="text-sm text-purple-800 dark:text-purple-200 space-y-1">
                    <li>üñ±Ô∏è <strong>Drag nodes</strong> to reposition them</li>
                    <li>üîç <strong>Scroll</strong> to zoom in/out</li>
                    <li>üëÜ <strong>Drag background</strong> to pan</li>
                    <li>üìä <strong>Node size</strong> = eigenvector centrality</li>
                    <li>üé® <strong>Color</strong> = community group</li>
                </ul>
            </div>

            <!-- Metrics Explanation -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100 mb-2">üìà About Eigenvector Centrality</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                    Unlike degree centrality (which just counts connections), eigenvector centrality
                    measures <em>quality</em> of connections.
                </p>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    Think of it like Google's PageRank: it's not just who you know, but
                    <strong>who they know</strong>.
                </p>
            </div>
        </div>

        <!-- Right Panel: Graph Visualization -->
        <div class="lg:w-2/3 relative" id="graph-container">
            <!-- Loading Indicator -->
            <div id="graph-loading" class="absolute inset-0 flex items-center justify-center bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm z-50" style="display: none;">
                <div class="text-center">
                    <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-green-600 border-t-transparent mb-4"></div>
                    <p class="text-lg font-semibold text-gray-900 dark:text-gray-100">Calculating graph layout...</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">This may take a few seconds for large networks</p>
                </div>
            </div>
            <!-- Graph will be rendered here by D3 -->
        </div>
    </div>

    <script type="module">
        import * as d3 from 'd3';
        import Alpine from 'alpinejs';
        import NetworkGraph from '../src/networkgraph.d3.js';
        import { createNetworkGraphApp } from '../js/network-graph.js';

        // Make D3 available globally for NetworkGraph
        window.d3 = d3;

        // Make Alpine available globally
        window.Alpine = Alpine;

        // Initial data for the network graph
        const initialData = {
            nodes: [
                { id: 'Alice', group: 1 },
                { id: 'Bob', group: 1 },
                { id: 'Charlie', group: 2 },
                { id: 'David', group: 2 },
                { id: 'Eve', group: 3 },
                { id: 'Frank', group: 3 },
                { id: 'Grace', group: 1 },
                { id: 'Henry', group: 2 },
                { id: 'Isabel', group: 4 },
                { id: 'John', group: 4 },
                { id: 'Kate', group: 5 },
                { id: 'Luke', group: 5 },
                { id: 'Mary', group: 6 },
                { id: 'Nick', group: 6 },
                { id: 'Oliver', group: 7 }
            ],
            links: [
                { source: 'Alice', target: 'Bob' },
                { source: 'Alice', target: 'Charlie' },
                { source: 'Bob', target: 'Charlie' },
                { source: 'Charlie', target: 'David' },
                { source: 'Eve', target: 'Frank' },
                { source: 'Eve', target: 'Alice' },
                { source: 'Grace', target: 'Alice' },
                { source: 'Henry', target: 'Bob' },
                { source: 'Henry', target: 'Eve' },
                { source: 'Isabel', target: 'John' },
                { source: 'Isabel', target: 'Kate' },
                { source: 'John', target: 'Luke' },
                { source: 'Kate', target: 'Mary' },
                { source: 'Luke', target: 'Nick' },
                { source: 'Mary', target: 'Oliver' },
                { source: 'Nick', target: 'Oliver' },
                { source: 'Oliver', target: 'Alice' },
                { source: 'Frank', target: 'Mary' },
                { source: 'David', target: 'Isabel' },
                { source: 'Grace', target: 'Kate' }
            ]
        };

        // Get container dimensions
        const container = document.getElementById('graph-container');
        const width = container.clientWidth;
        const height = container.clientHeight;

        // Initialize the network graph
        const graph = new NetworkGraph('#graph-container', width, height);
        graph.setData(initialData.nodes, initialData.links);

        // Handle window resize
        const handleResize = () => {
            const newWidth = container.clientWidth;
            const newHeight = container.clientHeight;
            graph.width = newWidth;
            graph.height = newHeight;
            graph.svg.attr('width', newWidth).attr('height', newHeight);
            graph.simulation.force('center', d3.forceCenter(newWidth / 2, newHeight / 2));
            graph.simulation.force('x', d3.forceX(newWidth / 2).strength(0.1));
            graph.simulation.force('y', d3.forceY(newWidth / 2).strength(0.1));
        };
        window.addEventListener('resize', handleResize);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            window.removeEventListener('resize', handleResize);
            if (graph) {
                graph.destroy();
            }
        });

        // Cleanup on visibility change (when switching pages in SPA)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && graph && graph.simulation) {
                // Pause simulation when page is hidden
                graph.simulation.stop();
            } else if (!document.hidden && graph && graph.simulation) {
                // Resume simulation when page becomes visible
                graph.simulation.restart();
            }
        });

        // Handle BFCache (back-forward cache) restoration
        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                // Page was restored from BFCache - force a clean reset
                console.log('Page restored from BFCache - resetting state');
                location.reload();
            }
        });

        // Dark mode is automatically handled by the d3Theme system in NetworkGraph
        // No additional setup needed here!

        // Register Alpine component
        window.networkGraphApp = () => createNetworkGraphApp(graph, initialData);

        // Start Alpine
        Alpine.start();
    </script>
    </div>
</body>
</html>
