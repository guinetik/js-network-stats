<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brazilian Networks - Parallel Computation Demo</title>
    <link rel="stylesheet" href="../styles/main.css">
    <script>
        // Detect dark mode from localStorage (same as main app)
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
        }
    </script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: transparent;
        }

        #graph-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.5) 0%, rgba(249, 250, 251, 0.5) 100%);
            position: relative;
        }

        .dark #graph-container {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.7) 0%, rgba(22, 33, 62, 0.7) 100%);
        }

        #graph-container svg {
            background: transparent;
        }

        .progress-bar {
            height: 4px;
            background: linear-gradient(90deg, #8b5cf6, #ec4899);
            transition: width 0.3s ease;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        .metric-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
            border-radius: 0.5rem;
            padding: 0.75rem;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .dark .metric-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(236, 72, 153, 0.2));
            border-color: rgba(139, 92, 246, 0.3);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 0.25rem;
        }

        .badge-green {
            background-color: #dcfce7;
            color: #166534;
        }

        .dark .badge-green {
            background-color: rgba(22, 101, 52, 0.3);
            color: #86efac;
        }

        .badge-yellow {
            background-color: #fef3c7;
            color: #92400e;
        }

        .dark .badge-yellow {
            background-color: rgba(146, 64, 14, 0.3);
            color: #fde047;
        }

        .badge-red {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .dark .badge-red {
            background-color: rgba(153, 27, 27, 0.3);
            color: #fca5a5;
        }
    </style>
</head>
<body class="dark:bg-transparent">
    <!-- Back Button -->
    <a
        href="../index.html"
        class="fixed top-4 right-4 z-50 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow-lg transition-colors"
    >
        ‚Üê Back to Home
    </a>

    <!-- Split Layout -->
    <div class="flex flex-col lg:flex-row h-screen" x-data="brazilianNetworksApp()">
        <!-- Left Panel: Controls & Info -->
        <div class="lg:w-1/3 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-r border-gray-200/50 dark:border-gray-700/50 overflow-y-auto p-6 space-y-6">
            <!-- Header -->
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2">
                    üáßüá∑ Brazilian Cities Networks
                </h1>
                <p class="text-gray-600 dark:text-gray-400">
                    Explore real-world social networks from Brazilian cities with parallel computation.
                </p>
            </div>

            <!-- What is this? -->
            <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-blue-900 dark:text-blue-300 mb-2">
                    üöÄ Parallel Computation Demo
                </h2>
                <p class="text-sm text-blue-800 dark:text-blue-200 mb-3">
                    This demo showcases <strong>Web Workers</strong> for parallel network analysis.
                    Large networks are processed across multiple CPU cores for faster computation.
                </p>
                <div class="flex items-center gap-2 text-xs">
                    <span class="badge" :class="workersSupported ? 'badge-green' : 'badge-red'">
                        <span x-show="workersSupported">‚úì Workers Supported</span>
                        <span x-show="!workersSupported">‚úó Workers Not Supported</span>
                    </span>
                    <span x-show="workersSupported" class="badge badge-yellow">
                        <span x-text="workerCount"></span> cores
                    </span>
                </div>
            </div>

            <!-- Network Selection -->
            <div class="space-y-3">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                    Data Loading
                </h2>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Choose Network:
                    </label>
                    <select
                        x-model="selectedNetwork"
                        class="w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 px-3 py-2 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    >
                        <option value="">-- Choose a city --</option>
                        <option value="caruaru">Caruaru (~130 edges, small)</option>
                        <option value="rj">Rio de Janeiro (~1,900 edges, medium)</option>
                        <option value="niteroi">Niter√≥i (~18,500 edges, large)</option>
                    </select>
                </div>

                <button
                    @click="loadNetwork()"
                    :disabled="!selectedNetwork || isLoading"
                    class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white px-4 py-3 rounded-lg font-semibold transition-colors shadow-sm"
                >
                    <span x-show="!isLoading">üìä Load Network</span>
                    <span x-show="isLoading">‚è≥ Loading...</span>
                </button>
            </div>

            <!-- Network Analysis (Sizes) -->
            <div class="space-y-3 border-t border-gray-200 dark:border-gray-700 pt-4">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                    ‚ö° Network Analysis (Node Sizes)
                </h2>

                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 space-y-2">
                    <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100">
                        Metrics to Calculate
                    </h3>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" x-model="selectedFeatures" value="degree" class="rounded">
                            <span class="text-gray-700 dark:text-gray-300">Degree Centrality</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" x-model="selectedFeatures" value="betweenness" class="rounded">
                            <span class="text-gray-700 dark:text-gray-300">Betweenness Centrality</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" x-model="selectedFeatures" value="clustering" class="rounded">
                            <span class="text-gray-700 dark:text-gray-300">Clustering Coefficient</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" x-model="selectedFeatures" value="eigenvector" class="rounded">
                            <span class="text-gray-700 dark:text-gray-300">Eigenvector Centrality</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" x-model="selectedFeatures" value="eigenvector-laplacian" class="rounded">
                            <span class="text-gray-700 dark:text-gray-300">Eigenvector (Laplacian) - for Spectral layout</span>
                        </label>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Node Size Based On:
                    </label>
                    <select
                        x-model="selectedSizeMetric"
                        :disabled="!networkLoaded || selectedFeatures.length === 0"
                        class="w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 px-3 py-2 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent disabled:opacity-50"
                    >
                        <option value="">-- Select a metric --</option>
                        <option value="degree" x-show="selectedFeatures.includes('degree')">Degree</option>
                        <option value="betweenness" x-show="selectedFeatures.includes('betweenness')">Betweenness</option>
                        <option value="clustering" x-show="selectedFeatures.includes('clustering')">Clustering</option>
                        <option value="eigenvector" x-show="selectedFeatures.includes('eigenvector')">Eigenvector</option>
                    </select>
                </div>

                <button
                    @click="analyzeNetwork()"
                    :disabled="!networkLoaded || analyzing || selectedFeatures.length === 0"
                    class="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white px-4 py-3 rounded-lg font-semibold transition-colors shadow-sm"
                >
                    <span x-show="!analyzing">‚ö° Analyze Network</span>
                    <span x-show="analyzing">‚è≥ Analyzing...</span>
                </button>

                <!-- Progress Bar -->
                <div x-show="analyzing" class="w-full bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                    <div class="progress-bar" :style="`width: ${progress * 100}%`"></div>
                </div>

                <div x-show="analyzing" class="text-sm text-center text-gray-600 dark:text-gray-400">
                    <span x-text="progressText"></span>
                </div>
            </div>

            <!-- Layout Controls -->
            <div class="space-y-3 border-t border-gray-200 dark:border-gray-700 pt-4">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">üéØ Layout Algorithm</h2>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Choose Layout:
                    </label>
                    <select
                        x-model="selectedLayout"
                        :disabled="!networkLoaded"
                        class="w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 px-3 py-2 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent disabled:opacity-50"
                    >
                        <template x-for="layout in availableLayouts" :key="layout.id">
                            <option :value="layout.id" x-text="layout.name"></option>
                        </template>
                    </select>
                </div>

                <button
                    @click="applyLayoutAlgorithm()"
                    :disabled="!networkLoaded"
                    class="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white px-4 py-3 rounded-lg font-semibold transition-colors shadow-sm"
                >
                    üéØ Apply Layout
                </button>

                <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-lg p-3">
                    <p class="text-xs text-yellow-800 dark:text-yellow-200">
                        <template x-for="layout in availableLayouts" :key="layout.id">
                            <div>
                                <strong x-text="`${layout.name}:`"></strong>
                                <span x-text="layout.description"></span>
                                <span x-show="layout.requiresStats" class="italic"> (requires analysis)</span>
                                <br>
                            </div>
                        </template>
                    </p>
                </div>
            </div>

            <!-- Graph-Level Statistics Results (Persistent) -->
            <div x-show="hasGraphStats" class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 rounded-lg p-4 border-2 border-blue-200 dark:border-blue-700">
                <h3 class="text-sm font-semibold text-blue-900 dark:text-blue-300 mb-3 flex items-center gap-2">
                    üìä Graph Statistics
                </h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-blue-800 dark:text-blue-200">Density:</span>
                        <span class="text-sm font-mono text-blue-600 dark:text-blue-400" x-text="graphStats ? graphStats.density?.toFixed(4) : '-'"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-blue-800 dark:text-blue-200">Diameter:</span>
                        <span class="text-sm font-mono text-blue-600 dark:text-blue-400" x-text="graphStats ? (graphStats.diameter === Infinity ? '‚àû' : graphStats.diameter) : '-'"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-blue-800 dark:text-blue-200">Avg Clustering:</span>
                        <span class="text-sm font-mono text-blue-600 dark:text-blue-400" x-text="graphStats ? graphStats['average_clustering']?.toFixed(4) : '-'"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-blue-800 dark:text-blue-200">Avg Path Length:</span>
                        <span class="text-sm font-mono text-blue-600 dark:text-blue-400" x-text="graphStats ? (graphStats['average_shortest_path'] === Infinity ? '‚àû' : graphStats['average_shortest_path']?.toFixed(2)) : '-'"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-blue-800 dark:text-blue-200">Components:</span>
                        <span class="text-sm font-mono text-blue-600 dark:text-blue-400" x-text="graphStats ? graphStats['connected_components'] : '-'"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-blue-800 dark:text-blue-200">Avg Degree:</span>
                        <span class="text-sm font-mono text-blue-600 dark:text-blue-400" x-text="graphStats ? graphStats['average_degree']?.toFixed(2) : '-'"></span>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-blue-200 dark:border-blue-700">
                    <p class="text-xs text-blue-700 dark:text-blue-300">
                        Calculated alongside node metrics
                    </p>
                </div>
            </div>

            <!-- Community Detection (Colors) -->
            <div class="space-y-3 border-t border-gray-200 dark:border-gray-700 pt-4">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                    üé® Community Detection (Node Colors)
                </h2>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Algorithm:
                    </label>
                    <select
                        x-model="selectedCommunityAlgorithm"
                        :disabled="!networkLoaded"
                        class="w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 px-3 py-2 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent disabled:opacity-50"
                    >
                        <option value="louvain">Louvain Method</option>
                    </select>
                </div>

                <button
                    @click="detectCommunities()"
                    :disabled="!networkLoaded || detectingCommunities"
                    class="w-full bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white px-4 py-3 rounded-lg font-semibold transition-colors shadow-sm"
                >
                    <span x-show="!detectingCommunities">üé® Detect Communities</span>
                    <span x-show="detectingCommunities">‚è≥ Detecting...</span>
                </button>
            </div>

            <!-- Community Detection Results (Persistent) -->
            <div x-show="hasCommunities" class="bg-gradient-to-br from-orange-50 to-pink-50 dark:from-orange-900/30 dark:to-pink-900/30 rounded-lg p-4 border-2 border-orange-200 dark:border-orange-700">
                <h3 class="text-sm font-semibold text-orange-900 dark:text-orange-300 mb-3 flex items-center gap-2">
                    üé® Community Detection Results
                </h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-orange-800 dark:text-orange-200">Communities Found:</span>
                        <span class="text-lg font-bold text-orange-600 dark:text-orange-400" x-text="stats.communities"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-orange-800 dark:text-orange-200">Modularity Score:</span>
                        <span class="text-lg font-bold text-orange-600 dark:text-orange-400" x-text="stats.modularity"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-orange-800 dark:text-orange-200">Computation Time:</span>
                        <span class="text-sm font-semibold text-orange-600 dark:text-orange-400" x-text="stats.communityTime"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-orange-800 dark:text-orange-200">Algorithm:</span>
                        <span class="text-sm font-semibold text-orange-600 dark:text-orange-400" x-text="selectedCommunityAlgorithm"></span>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-orange-200 dark:border-orange-700">
                    <p class="text-xs text-orange-700 dark:text-orange-300">
                        Node colors represent their community assignments
                    </p>
                </div>
            </div>

            <!-- Node Info Container -->
            <div id="node-info-container" class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-4">
                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Information</h3>
                <div class="text-sm">
                    <!-- Default state -->
                    <template x-if="nodeInfo.type === 'default'">
                        <div class="text-gray-600 dark:text-gray-400" x-text="nodeInfo.message"></div>
                    </template>

                    <!-- Loading state -->
                    <template x-if="nodeInfo.type === 'loading'">
                        <div class="space-y-1">
                            <div class="text-blue-600 dark:text-blue-400"><strong>‚è≥ Loading...</strong></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400" x-text="nodeInfo.message"></div>
                        </div>
                    </template>

                    <!-- Success state -->
                    <template x-if="nodeInfo.type === 'success'">
                        <div class="space-y-1">
                            <div class="text-green-600 dark:text-green-400"><strong>‚úì</strong> <span x-text="nodeInfo.message"></span></div>
                            <div x-show="nodeInfo.details?.nodes" class="text-sm text-gray-600 dark:text-gray-400">
                                <span x-text="nodeInfo.details?.nodes"></span> nodes, <span x-text="nodeInfo.details?.edges"></span> edges
                            </div>
                            <div x-show="nodeInfo.details?.description" class="text-xs text-gray-500 dark:text-gray-400 mt-2" x-text="nodeInfo.details?.description"></div>
                            <div x-show="nodeInfo.details?.time" class="text-xs text-purple-600 dark:text-purple-400 mt-2">
                                Time: <span x-text="nodeInfo.details?.time"></span>
                            </div>
                            <div x-show="nodeInfo.details?.metric" class="text-xs text-blue-600 dark:text-blue-400 mt-2">
                                Primary metric: <span x-text="nodeInfo.details?.metric"></span>
                            </div>
                        </div>
                    </template>

                    <!-- Error state -->
                    <template x-if="nodeInfo.type === 'error'">
                        <div class="text-red-600 dark:text-red-400">
                            <strong>‚ùå</strong> <span x-text="nodeInfo.message"></span>
                        </div>
                    </template>

                    <!-- Layout applied -->
                    <template x-if="nodeInfo.type === 'layout-applied'">
                        <div class="space-y-1">
                            <div class="text-green-600 dark:text-green-400"><strong>‚úì</strong> <span x-text="nodeInfo.message"></span></div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-2" x-text="nodeInfo.details?.description"></div>
                        </div>
                    </template>

                    <!-- Node hover -->
                    <template x-if="nodeInfo.type === 'node-hover'">
                        <div class="space-y-1">
                            <div class="text-blue-600 dark:text-blue-400 font-semibold">
                                üîµ <span x-text="nodeInfo.details?.id"></span>
                            </div>
                            <div class="text-sm text-gray-700 dark:text-gray-300 space-y-0.5">
                                <p x-show="nodeInfo.details?.community !== null"><strong>üé® Community:</strong> <span x-text="nodeInfo.details?.community"></span></p>
                                <p><strong>Centrality:</strong> <span x-text="nodeInfo.details?.centrality"></span></p>
                                <p x-show="nodeInfo.details?.degree"><strong>Degree:</strong> <span x-text="nodeInfo.details?.degree"></span></p>
                                <p x-show="nodeInfo.details?.betweenness"><strong>Betweenness:</strong> <span x-text="nodeInfo.details?.betweenness"></span></p>
                                <p x-show="nodeInfo.details?.clustering"><strong>Clustering:</strong> <span x-text="nodeInfo.details?.clustering"></span></p>
                                <p x-show="nodeInfo.details?.eigenvector"><strong>Eigenvector:</strong> <span x-text="nodeInfo.details?.eigenvector"></span></p>
                                <p x-show="nodeInfo.details?.closeness"><strong class="text-green-700 dark:text-green-400">Closeness:</strong> <span x-text="nodeInfo.details?.closeness"></span></p>
                                <p x-show="nodeInfo.details?.egoDensity"><strong class="text-purple-700 dark:text-purple-400">Ego Density:</strong> <span x-text="nodeInfo.details?.egoDensity"></span></p>
                                <p x-show="nodeInfo.details?.cliques"><strong>Cliques:</strong> <span x-text="nodeInfo.details?.cliques"></span></p>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Network Statistics -->
            <div x-show="networkLoaded" class="space-y-3 border-t border-gray-200 dark:border-gray-700 pt-4">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                    Network Statistics
                </h2>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="text-xs text-gray-600 dark:text-gray-400">Nodes</div>
                        <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" x-text="stats.nodes"></div>
                    </div>
                    <div class="metric-card">
                        <div class="text-xs text-gray-600 dark:text-gray-400">Edges</div>
                        <div class="text-2xl font-bold text-pink-600 dark:text-pink-400" x-text="stats.edges"></div>
                    </div>
                    <div class="metric-card">
                        <div class="text-xs text-gray-600 dark:text-gray-400">Avg Degree</div>
                        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" x-text="stats.avgDegree"></div>
                    </div>
                    <div class="metric-card">
                        <div class="text-xs text-gray-600 dark:text-gray-400">Analysis Time</div>
                        <div class="text-2xl font-bold text-green-600 dark:text-green-400" x-text="stats.analysisTime"></div>
                    </div>
                    <div x-show="stats.communities" class="metric-card">
                        <div class="text-xs text-gray-600 dark:text-gray-400">Communities</div>
                        <div class="text-2xl font-bold text-orange-600 dark:text-orange-400" x-text="stats.communities"></div>
                    </div>
                    <div x-show="stats.modularity" class="metric-card">
                        <div class="text-xs text-gray-600 dark:text-gray-400">Modularity</div>
                        <div class="text-2xl font-bold text-cyan-600 dark:text-cyan-400" x-text="stats.modularity"></div>
                    </div>
                </div>

                <div x-show="useWorkers" class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3 text-sm">
                    <span class="font-semibold text-green-800 dark:text-green-300">
                        ‚ö° Using parallel computation
                    </span>
                    <span class="text-green-700 dark:text-green-400">
                        - <span x-text="workerCount"></span> workers active
                    </span>
                </div>

                <div x-show="!useWorkers && networkLoaded" class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-3 text-sm">
                    <span class="font-semibold text-yellow-800 dark:text-yellow-300">
                        ‚ö† Single-threaded mode
                    </span>
                    <span class="text-yellow-700 dark:text-yellow-400">
                        - Network too small for workers
                    </span>
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-purple-50 dark:bg-purple-900/30 rounded-lg p-4">
                <h3 class="text-sm font-semibold text-purple-900 dark:text-purple-300 mb-2">üí° How to interact</h3>
                <ul class="text-sm text-purple-800 dark:text-purple-200 space-y-1">
                    <li>üñ±Ô∏è <strong>Drag nodes</strong> to reposition them</li>
                    <li>üîç <strong>Scroll</strong> to zoom in/out</li>
                    <li>üëÜ <strong>Drag background</strong> to pan</li>
                    <li>üé® <strong>Node size</strong> = eigenvector centrality</li>
                    <li>üáßüá∑ <strong>Data</strong> = Real Brazilian city networks</li>
                </ul>
            </div>
        </div>

        <!-- Right Panel: Graph Visualization -->
        <div class="lg:w-2/3 relative" id="graph-container">
            <!-- Loading Indicator -->
            <div id="graph-loading" class="absolute inset-0 flex items-center justify-center bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm z-50" style="display: none;">
                <div class="text-center">
                    <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-green-600 border-t-transparent mb-4"></div>
                    <p class="text-lg font-semibold text-gray-900 dark:text-gray-100">Calculating graph layout...</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">This may take a few seconds for large networks</p>
                </div>
            </div>
            <!-- Graph will be rendered here by NetworkGraph -->
        </div>
    </div>

    <script type="module">
        import * as d3 from 'd3';
        import Alpine from 'alpinejs';
        import NetworkGraph from '../src/networkgraph.d3.js';
        import { createBrazilianNetworksApp } from '../js/brazilian-networks.js';

        // Make D3 available globally for NetworkGraph
        window.d3 = d3;

        // Make Alpine available globally
        window.Alpine = Alpine;

        // Get container dimensions
        const container = document.getElementById('graph-container');
        const width = container.clientWidth;
        const height = container.clientHeight;

        // Initialize the network graph with features for Brazilian networks
        const graph = new NetworkGraph('#graph-container', width, height, {
            features: ['degree', 'betweenness', 'clustering', 'eigenvector'],
            verbose: false
        });

        // Handle window resize
        const handleResize = () => {
            const newWidth = container.clientWidth;
            const newHeight = container.clientHeight;
            graph.width = newWidth;
            graph.height = newHeight;
            graph.svg.attr('width', newWidth).attr('height', newHeight);
            graph.simulation.force('center', d3.forceCenter(newWidth / 2, newHeight / 2));
            graph.simulation.force('x', d3.forceX(newWidth / 2).strength(0.1));
            graph.simulation.force('y', d3.forceY(newHeight / 2).strength(0.1));
        };
        window.addEventListener('resize', handleResize);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            window.removeEventListener('resize', handleResize);
            if (graph) {
                graph.destroy();
            }
        });

        // Cleanup on visibility change (when switching pages in SPA)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && graph && graph.simulation) {
                // Pause simulation when page is hidden
                graph.simulation.stop();
            } else if (!document.hidden && graph && graph.simulation) {
                // Resume simulation when page becomes visible
                graph.simulation.restart();
            }
        });

        // Handle BFCache (back-forward cache) restoration
        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                // Page was restored from BFCache - force a clean reset
                console.log('Page restored from BFCache - resetting state');

                // Clear the graph
                if (graph) {
                    graph.data.nodes = [];
                    graph.data.links = [];
                    graph.updateGraph();
                }

                // Reset Alpine state by forcing a page reload
                // This ensures everything starts fresh
                location.reload();
            }
        });

        // Register Alpine component
        window.brazilianNetworksApp = () => createBrazilianNetworksApp(graph);

        // Start Alpine
        Alpine.start();
    </script>
</body>
</html>
