<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree Builder - @guinetik/network-js</title>
    <link rel="stylesheet" href="../styles/main.css">
    <script>
        // Detect dark mode from localStorage (same as main app)
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
        }
    </script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: transparent;
        }

        #graph-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.5) 0%, rgba(249, 250, 251, 0.5) 50%, rgba(243, 244, 246, 0.5) 100%);
            position: relative;
        }

        .dark #graph-container {
            background: linear-gradient(135deg, rgba(15, 32, 39, 0.7) 0%, rgba(32, 58, 67, 0.7) 50%, rgba(44, 83, 100, 0.7) 100%);
        }

        #graph-container svg {
            background: transparent;
        }

        /* Dialog styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-dialog {
            background: white;
            border-radius: 8px;
            padding: 24px;
            min-width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .dark .modal-dialog {
            background: #1f2937;
        }

        .modal-title {
            margin: 0 0 16px 0;
            font-size: 20px;
            font-weight: 600;
            color: #111827;
        }

        .dark .modal-title {
            color: #f9fafb;
        }

        .modal-content {
            margin-bottom: 20px;
        }

        .modal-content > div {
            margin-bottom: 16px;
        }

        .modal-content label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .dark .modal-content label {
            color: #d1d5db;
        }

        .modal-content .input-field,
        .modal-content select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .dark .modal-content .input-field,
        .dark .modal-content select {
            background: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .modal-btn.primary {
            background: #10b981;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #059669;
        }

        .modal-btn.secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .dark .modal-btn.secondary {
            background: #4b5563;
            color: #d1d5db;
        }

        .modal-btn.secondary:hover {
            background: #d1d5db;
        }

        .dark .modal-btn.secondary:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="dark:bg-transparent">
    <!-- Back Button -->
    <a
        href="../index.html"
        class="fixed top-4 right-4 z-50 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow-lg transition-colors"
    >
        ← Back to Home
    </a>

    <!-- Split Layout -->
    <div class="flex flex-col lg:flex-row h-screen" x-data="familyTreeApp()">
        <!-- Left Panel: Info & Controls -->
        <div class="lg:w-1/3 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-r border-gray-200/50 dark:border-gray-700/50 overflow-y-auto p-6 space-y-6">
            <!-- Header -->
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2">
                    🌳 Family Tree Builder
                </h1>
                <p class="text-gray-600 dark:text-gray-400">
                    Build and visualize your family tree interactively. Start with yourself and add relatives to see the network grow.
                </p>
            </div>

            <!-- What is this? -->
            <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-green-900 dark:text-green-300 mb-2">What is this?</h2>
                <p class="text-sm text-green-800 dark:text-green-200">
                    A network visualization of family relationships. Each color represents a different
                    relationship type. The tree auto-saves to your browser's storage every 30 seconds.
                </p>
            </div>

            <!-- Add Relatives -->
            <div class="space-y-3">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Add Relatives</h2>

                <button @click="addParents()" class="w-full bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm">
                    👨‍👩‍👧 Add Parents
                </button>

                <button @click="addSibling()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm">
                    👫 Add Sibling
                </button>

                <button @click="addGrandparents()" class="w-full bg-amber-700 hover:bg-amber-800 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm">
                    👴👵 Add Grandparents
                </button>

                <button @click="addUncleAunt()" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm">
                    🧑‍🤝‍🧑 Add Uncle/Aunt
                </button>

                <button @click="addCousin()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm">
                    👯 Add Cousin
                </button>

                <button @click="addChild()" class="w-full bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm">
                    👶 Add Child
                </button>

                <button @click="addNieceNephew()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm">
                    🧒 Add Niece/Nephew
                </button>

                <button @click="addPartner()" class="w-full bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm">
                    💑 Add Partner/Spouse
                </button>
            </div>

            <!-- Actions -->
            <div class="space-y-2 border-t border-gray-200 dark:border-gray-700 pt-4">
                <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100 mb-2">Actions</h3>

                <button @click="saveFamily()" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm text-sm">
                    💾 Save Family
                </button>

                <button @click="saveImage()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm text-sm">
                    📸 Save as Image
                </button>

                <button @click="lockGraph()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm text-sm">
                    🔒 Lock Graph
                </button>

                <button @click="unlockGraph()" class="w-full bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm text-sm">
                    🔓 Unlock Graph
                </button>

                <button @click="resetTree()" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm text-sm">
                    🗑️ Reset Tree
                </button>
            </div>

            <!-- Legend -->
            <div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-4">
                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Relationship Colors</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-purple-600"></div>
                        <span class="text-gray-700 dark:text-gray-300">You</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-pink-500"></div>
                        <span class="text-gray-700 dark:text-gray-300">Parents</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-blue-500"></div>
                        <span class="text-gray-700 dark:text-gray-300">Siblings</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-orange-500"></div>
                        <span class="text-gray-700 dark:text-gray-300">Uncles/Aunts</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-purple-500"></div>
                        <span class="text-gray-700 dark:text-gray-300">Cousins</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-amber-700"></div>
                        <span class="text-gray-700 dark:text-gray-300">Grandparents</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-cyan-500"></div>
                        <span class="text-gray-700 dark:text-gray-300">Nieces/Nephews</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-rose-500"></div>
                        <span class="text-gray-700 dark:text-gray-300">Partners/Spouses</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-teal-500"></div>
                        <span class="text-gray-700 dark:text-gray-300">Children</span>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4">
                <h3 class="text-sm font-semibold text-blue-900 dark:text-blue-300 mb-2">💡 How to use</h3>
                <ul class="text-sm text-blue-800 dark:text-blue-200 space-y-1">
                    <li>🖱️ <strong>Drag nodes</strong> to arrange your tree</li>
                    <li>💾 <strong>Auto-saves</strong> every 30 seconds</li>
                    <li>🔒 <strong>Lock</strong> to freeze positions</li>
                    <li>📸 <strong>Download</strong> as PNG image</li>
                </ul>
            </div>
        </div>

        <!-- Right Panel: Graph Visualization -->
        <div class="lg:w-2/3 relative" id="graph-container">
            <!-- Graph will be rendered here by D3 -->
        </div>
    </div>

    <script type="module">
        import * as d3 from 'd3';
        import Alpine from 'alpinejs';
        import NetworkGraph from '../src/networkgraph.d3.js';
        import DialogForm from '../src/dialog.js';
        import { createFamilyTreeApp } from '../js/family-tree.js';

        // Make D3 available globally for NetworkGraph
        window.d3 = d3;

        // Make Alpine available globally (but don't start yet)
        window.Alpine = Alpine;

        // Dark mode is automatically handled by the d3Theme system in NetworkGraph
        // No additional setup needed here!

        // Define family relationship groups
        const FAMILY_GROUPS = {
            YOU: 1,
            PARENT: 2,
            SIBLING: 3,
            UNCLE_AUNT: 4,
            COUSIN: 5,
            GRANDPARENT: 6,
            NIECE_NEPHEW: 7,
            CHILD: 8,
            PARTNER: 9
        };

        // Group colors
        const GROUP_COLORS = {
            [FAMILY_GROUPS.YOU]: '#9333ea',           // Purple
            [FAMILY_GROUPS.PARENT]: '#ec4899',        // Pink
            [FAMILY_GROUPS.SIBLING]: '#3b82f6',       // Blue
            [FAMILY_GROUPS.UNCLE_AUNT]: '#f97316',    // Orange
            [FAMILY_GROUPS.COUSIN]: '#a855f7',        // Purple light
            [FAMILY_GROUPS.GRANDPARENT]: '#b45309',   // Amber dark
            [FAMILY_GROUPS.NIECE_NEPHEW]: '#06b6d4',  // Cyan
            [FAMILY_GROUPS.CHILD]: '#14b8a6',         // Teal
            [FAMILY_GROUPS.PARTNER]: '#f43f5e'        // Rose
        };

        const STORAGE_KEY = 'familyTree';
        // Track relationships
        const relationships = {
            parents: new Map(),
            children: new Map(),
            siblings: new Set(),
            uncles: new Map(),
            cousins: new Map()
        };
        // Initialize the network graph with just YOU
        const initialData = {
            nodes: [
                { id: 'YOU', group: FAMILY_GROUPS.YOU }
            ],
            links: []
        };
        // Setup UI
        const container = document.getElementById('graph-container');
        const width = container.clientWidth;
        const height = container.clientHeight;
        const graph = new NetworkGraph('#graph-container', width, height);
        // Override default color scale
        graph.nodeColors = (group) => GROUP_COLORS[group] || "#999";
        // Load saved family or use initial
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                graph.setData(data.nodes, data.links);
            } catch(e) {
                graph.setData(initialData.nodes, initialData.links);
            }
        } else {
            graph.setData(initialData.nodes, initialData.links);
        }

        // Save function
        function saveFamily() {
            const data = {
                nodes: graph.data.nodes,
                links: graph.data.links
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            console.log('Family tree saved!');
        }

        // Auto-save every 30 seconds
        setInterval(saveFamily, 30000);

        // Register Alpine component for family tree controls
        // Create the component object once with all dependencies
        const appComponent = createFamilyTreeApp(
            graph,
            FAMILY_GROUPS,
            initialData,
            STORAGE_KEY,
            DialogForm,
            saveFamily
        );

        // Register it as a function that returns the component
        window.familyTreeApp = () => appComponent;

        // Now start Alpine after component is registered
        Alpine.start();

        // Handle window resize
        window.addEventListener('resize', () => {
            const newWidth = container.clientWidth;
            const newHeight = container.clientHeight;
            graph.width = newWidth;
            graph.height = newHeight;
            graph.svg.attr('width', newWidth).attr('height', newHeight);
            graph.simulation.force('center', d3.forceCenter(newWidth / 2, newHeight / 2));
            graph.simulation.force('x', d3.forceX(newWidth / 2).strength(0.1));
            graph.simulation.force('y', d3.forceY(newHeight / 2).strength(0.1));
        });
    </script>
    </div>
</body>
</html>
